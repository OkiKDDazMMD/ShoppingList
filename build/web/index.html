<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>test count</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    /* 簡単なスタイリング */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden; /* Flutterアプリが全画面表示される際にスクロールバーが出ないように */
    }
    #login-container {
      font-family: sans-serif;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 2rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      background-color: white;
      z-index: 10; /* Flutterアプリの上に表示されるように */
    }
    #login-container input {
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
    #login-container button {
      padding: 0.75rem 1.5rem;
      background-color: #4285F4; /* Google Blue */
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    #login-container button:hover {
      background-color: #357ae8;
    }
    #login-error {
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    #flutter-container {
      /* 最初はFlutterの表示領域を隠しておく */
      display: none;
      /* Flutterアプリのコンテンツが表示されるので、画面全体を使うようにする */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5; /* ログインフォームの下に表示されるように */
    }
  </style>
</head>

<body>
  <div id="login-container">
    <h2>ログインしてください</h2>
    <input type="email" id="email" placeholder="メールアドレス" required><br><br>
    <input type="password" id="password" placeholder="パスワード" required><br><br>
    <button id="login-button">ログイン</button>
    <p id="login-error" style="color: red;"></p>
  </div>

  <div id="flutter-container"></div>

  <!-- ... Firebase SDKs は通常 <head> か、上記スクリプトの前に置くことが多いですが、ここでは場所自体は直接的な問題ではありません。 ... -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebaseの初期化
    const firebaseConfig = {
      apiKey: "AIzaSyBIjgEC3Cu8c5X9UxhgmZzxeFnn8NceigI",
      authDomain: "friendlyeats-6010d.firebaseapp.com",
      projectId: "friendlyeats-6010d",
      storageBucket: "friendlyeats-6010d.firebasestorage.app",
      messagingSenderId: "1064013134599",
      appId: "1:1064013134599:web:9a14d3c4962f4be44863a2",
      measurementId: "G-36QDXF9CEL"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    // ▼▼▼ 変更点: ここからが主要なロジック ▼▼▼
    // DOM要素の参照を取得
    const loginContainer = document.getElementById('login-container');
    const flutterContainer = document.getElementById('flutter-container');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const loginError = document.getElementById('login-error');

    let flutterScriptsLoaded = false; // FlutterのJSファイルがロードされたかどうかのフラグ
    let flutterAppStarted = false;    // Flutterアプリ自体が起動されたかどうかのフラグ

    /**
     * Flutterアプリを初期化して起動する関数
     */
    function startFlutterApp() {
        if (flutterAppStarted) {
            // アプリが既に起動済みなら、表示を切り替えるだけでOK
            loginContainer.style.display = 'none';
            flutterContainer.style.display = 'block';
            return;
        }

        // ログインフォームを隠し、Flutterのコンテナを表示
        loginContainer.style.display = 'none';
        flutterContainer.style.display = 'block';

        // Flutterのスクリプトがまだロードされていなければ、動的にロードする
        if (!flutterScriptsLoaded) {
            // flutter.js を動的にロード
            const flutterJsScript = document.createElement('script');
            flutterJsScript.src = 'flutter.js'; // `flutter build web`で生成される`flutter.js`のパス
            flutterJsScript.defer = true; // 遅延ロード
            
            // flutter.jsがロード完了したときに実行される処理
            flutterJsScript.onload = () => {
                flutterScriptsLoaded = true; // ロード済みフラグを立てる

                // `flutter.js`がロードされると`_flutter.loader`が利用可能になります。
                // ここでFlutterのエントリポイントをロードして、アプリを起動します。
                _flutter.loader.loadEntrypoint({
                    hostElement: flutterContainer, // Flutterアプリを表示するHTML要素
                    onEntrypointLoaded: function(engineInitializer) {
                        engineInitializer.initializeEngine().then(function(appRunner) {
                            appRunner.runApp(); // Flutterアプリを実行
                            flutterAppStarted = true; // アプリ起動完了
                            console.log('?? Flutterアプリが正常に起動しました！');
                        });
                    }
                });
            };
            // 生成したスクリプトタグを<body>の最後に追加して、ロードを開始
            document.body.appendChild(flutterJsScript);
        }
    }

    /**
     * Firebaseの認証状態を監視する
     */
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // ユーザーがログインしている場合
        console.log('? ログイン済みです。Flutterアプリを起動します。');
        startFlutterApp(); // Flutterアプリ起動処理を呼び出す
      } else {
        // ユーザーがログインしていない場合
        console.log('? ログインしていません。ログインフォームを表示します。');
        loginContainer.style.display = 'block';
        flutterContainer.style.display = 'none';
        // もしFlutterアプリが既に起動していた場合（例: ログアウト時）、
        // その表示を隠すためにflutterContainerをdisplay:noneにしています。
        // Flutterアプリ自体を完全に停止させる必要がある場合は、より複雑な対応が必要です。
        // 通常はFlutterアプリ内でログアウトを検知し、適切な画面に遷移させるのが良いでしょう。
      }
    });

    /**
     * ログインボタンのクリックイベント
     */
    loginButton.addEventListener('click', function() {
      const email = emailInput.value;
      const password = passwordInput.value;
      
      loginError.textContent = ''; // エラーメッセージをクリア

      // Firebase Authenticationでサインインを試みる
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // ログイン成功！
          // onAuthStateChanged が自動的に検知して startFlutterApp を呼び出すので、
          // ここでは特に何もしなくても良いです。
          console.log('?? ログインに成功しました！', userCredential.user);
        })
        .catch((error) => {
          // ログイン失敗
          console.error('?? ログインエラー:', error);
          let errorMessage = 'ログインに失敗しました。';
          if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
              errorMessage = 'メールアドレスまたはパスワードが間違っています。';
          } else if (error.code === 'auth/invalid-email') {
              errorMessage = '無効なメールアドレスです。';
          } else if (error.code === 'auth/user-disabled') {
              errorMessage = 'このアカウントは無効になっています。';
          }
          loginError.textContent = errorMessage; // エラーメッセージを表示
        });
    });
    
  </script>

</body>
</html>